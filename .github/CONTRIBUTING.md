# Contributing to the PACE-HRH Project

## Code Style

NOTE: As of July 2023 PACE-HRH is in the process of cleaning up code to meet these style guidelines.

PACE-HRH follows [the tidyverse style guide]: https://style.tidyverse.org/, with the following exceptions:

#### Names of variables, objects, functions, and function parameters

PACE-HRH uses variations on camel case (e.g. variableName or ObjectName) for names. PACE-HRH code does not use snake case (variable_name) or dotted case (variable.name)

* Public functions and objects (public names that would appear in the package reference and be visible to the pacehrh:: operator) use camel case with an upper case first letter. Example: CheckInputExcelFileFormat()

* Internal functions use camel case with a lower case first letter. Example: loadTable()

* Function parameters use camel case with a lower case first letter. Example: .getMinMaxRates <- function(initRates, limits) { ... }

* Internal functions intended to be scoped to one source file may have a leading period: Example: .getRatesLimits() (R doesn't actually support private scoping visibility, but we follow this convention to give a hint to a function's intended scope. These "private" functions will still be visible to anybody using the pacehrh::: operator.)

* If you have free reign, treat data labels (for example, data frame column names) like any other variable and use camel case with a lower case first letter. But be mindful that data labels are often inherited from an external data source, and it can more sense to follow whatever conventions the data provider has used than to impose new ones. (Say you're using R's famous built-in _iris_ dataset. It's likely readers of your code will be familiar with the column names: Sepal.Length, Sepal.Width, etc. Your code will be easier to understand if you stick with these column names, even though they don't match the PACE-HRH code style standard. DHS datasets can have scores of fields, with ugly names like v008, v011, v005, midx, m3h-j, etc. You might be tempted to substitute more descriptive names, but recognize that the original forms are used as is in many places, e.g.  [https://dhsprogram.com/pubs/pdf/DHSG1/Guide_to_DHS_Statistics_DHS-7_v2.pdf](Guide to DHS Statistics).

#### Line lengths

PACE-HRH style allows for 120-character lines (instead of the tidverse default of 80).

#### return() statements

The tidyverse style guide recommends avoiding return() statements at the end of functions and instead relying on R's native behavior of returning the value of the last evaluated expression. We prefer using return() even at the end of functions because it makes the behavior of the code more explicit, especially for less experienced readers of the code. 

#### Using styler and lintr to get code style right

The R packages [https://styler.r-lib.org/](styler) and [https://lintr.r-lib.org/](lintr) are the core tools for managing code style.

The styler package reformats code according to whatever style rules have been set up.

The lintr package checks for code style problems. 

Linting configuration is controlled by the .lint file in the package root directory. lintr's default configuration is based on the tidyverse style, so the pacehrh .lint file invokes the default configuration with the exceptions noted previously.

The following __lintr__ command line checks for correctly formatted code:

With the .lintr file in place, the command to lint a file is:

```
lint("<r-source-code-file-path>")
```

For example:

```
lint("R/pace_rates_matrix.R")
```

The long form of the lint() command duplicating the behavior of the .lint file is:

```
lint(
  "<r-source-code-file-path>",
  linters = linters_with_defaults(
    line_length_linter = line_length_linter(length = 120L),
    object_name_linter = object_name_linter(styles = c("camelCase", "CamelCase", "symbols"))
  )
)
```

Like __styler__, the RStudio _Code/Reformat Code_ command also modifies code to bring it close to the tidyverse standard. Using __styler__ has the advantage that both __styler__ and __lintr__ install commands into the RStudio _Addins_ list.

<img src="rstudio-addins-menu.png" width="200" height="300" />

#### Disabling linting

A well-known glitch with linting is the "no visible binding for variable 'variableName'" message that pops up when ggplot and data.table are used in standard ways. The underlying cause is that ggplot and data.table take advantage of R's meta-language features to implement simple and expressive function call syntax, but linters don't know that and raise a warning. The best approach here is to disable linting for specific blocks of code. (Turning off the object_usage_linter component is a bad idea because several other useful checks would also be turned off.)

__lintr__ supports code comment macros to disable linting for specific blocks of code. In this example, warnings would be generated by object labels (Year, CadreMember, Category) that __data.table__ understands correctly to be column names.

```
  # nolint start

  tokens <- data.table::tstrsplit(dt[, Category], tokenSeparator)
  dt[, Year := as.numeric(tokens[[1]])]
  dt[, CadreMember := tokens[[2]]]

  # Remove unnecessary columns
  dt <- dt[CadreMember != "Total"]
  dt <- dt[CadreMember != "Unassigned"]

  # Cast to the desired final format
  dt <-
    data.table::dcast(
      dt,
      Indicator + Year ~ CadreMember,
      value.var = "allocation",
      fill = 0
    )

  # nolint end

```
